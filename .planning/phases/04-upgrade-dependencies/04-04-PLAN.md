---
phase: 04-upgrade-dependencies
plan: 04
type: execute
wave: 4
depends_on: ["04-03"]
files_modified: [package.json, pnpm-lock.yaml]
autonomous: false

must_haves:
  truths:
    - "Core runtime dependencies are upgraded to their latest major versions"
    - "Vue Router 5 migration is complete and functional"
    - "@vueuse/core 14 works with application code"
    - "All application features continue to work as expected"
    - "No runtime errors or breaking changes in production"
  artifacts:
    - path: "package.json"
      provides: "Updated major versions for runtime dependencies"
      contains: "vue-router: ^5, @vueuse/core: ^14"
    - path: "pnpm-lock.yaml"
      provides: "Lock file with resolved major runtime versions"
      min_lines: 100
    - path: "src/router/index.ts"
      provides: "Vue Router 5 compatible router configuration"
      contains: "createRouter"
  key_links:
    - from: "vue-router@5"
      to: "src/router/index.ts"
      via: "Router configuration must use Vue Router 5 API"
      pattern: "createRouter|createWebHistory"
    - from: "@vueuse/core@14"
      to: "src/**/*.vue"
      via: "VueUse composables usage"
      pattern: "use[A-Z]"
---

<objective>
Upgrade core runtime dependencies to their latest major versions (Vue Router 4→5, @vueuse/core 13→14, and others) to access modern features and ensure long-term maintainability.

Purpose: Runtime dependencies are upgraded last because they have the highest risk of introducing breaking changes that affect user-facing features. With dev tooling already upgraded, we can now safely upgrade runtime deps with comprehensive testing.
Output: Updated package.json with all runtime dependencies at latest major versions, Vue Router 5 migration complete, all features verified through manual testing.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-upgrade-dependencies/04-RESEARCH.md
@.planning/phases/04-upgrade-dependencies/04-01-SUMMARY.md
@.planning/phases/04-upgrade-dependencies/04-02-SUMMARY.md
@.planning/phases/04-upgrade-dependencies/04-03-SUMMARY.md
@package.json
@src/router/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Research Vue Router 5 breaking changes</name>
  <files>src/router/index.ts</files>
  <action>
Before upgrading, read the current router configuration to understand what features are being used:

Read `src/router/index.ts` to identify:
- Router creation pattern (createRouter, createWebHistory)
- Navigation guards usage
- Route meta fields
- Dynamic route matching
- Any use of deprecated Vue Router 4 APIs

Research Vue Router 5 migration guide (or note common breaking changes from research):
- Check if current code uses any deprecated APIs
- Identify what needs to change for Vue Router 5 compatibility

Document findings: "Current router uses [features]. Vue Router 5 requires [changes if any]."

This is a READ-ONLY task. Do NOT modify code yet.
  </action>
  <verify>
src/router/index.ts has been read and analyzed.
Current router features are documented.
Potential breaking changes are identified.
  </verify>
  <done>
Router configuration is understood.
Vue Router 5 migration requirements are documented.
Ready to proceed with upgrade.
  </done>
</task>

<task type="auto">
  <name>Task 2: Upgrade @vueuse/core and @deviltea/vue-router-middleware</name>
  <files>package.json, pnpm-lock.yaml</files>
  <action>
Start with lower-risk runtime dependencies before Vue Router:

Upgrade @vueuse/core:
```bash
npx taze -f "@vueuse/core" major -w
pnpm install
```

@vueuse/core 13→14 is typically backward compatible, but check for warnings.

Upgrade @deviltea/vue-router-middleware:
```bash
npx taze -f "@deviltea/vue-router-middleware" major -w
pnpm install
```

This is a minor 0.0.3 → 0.0.4 upgrade, but treat as major due to 0.x instability.

Test build and type-check:
```bash
pnpm type-check
pnpm build
```

If type errors occur, they may be due to improved type inference in @vueuse/core 14. Fix type errors if simple (add explicit types), otherwise document for checkpoint review.
  </action>
  <verify>
@vueuse/core upgraded to 14.x.
@deviltea/vue-router-middleware upgraded to 0.0.4.
`pnpm install` completes successfully.
`pnpm type-check` passes (or type errors are documented).
`pnpm build` succeeds.
  </verify>
  <done>
@vueuse/core 14 and @deviltea/vue-router-middleware 0.0.4 installed.
Build and type-check pass.
  </done>
</task>

<task type="auto">
  <name>Task 3: Upgrade Vue Router to v5</name>
  <files>package.json, pnpm-lock.yaml, src/router/index.ts</files>
  <action>
Upgrade Vue Router to v5:
```bash
npx taze -f "vue-router" major -w
pnpm install
```

Check for peer dependency warnings or errors. Vue Router 5 should be compatible with Vue 3.5.

Run type-check first:
```bash
pnpm type-check
```

If type errors occur in src/router/index.ts or components using router:
- Check error messages for deprecated API usage
- Common Vue Router 5 changes:
  - NavigationGuard type signatures may have changed
  - RouteLocationNormalized may have type refinements
  - Some types may be renamed or removed

Fix type errors based on Vue Router 5 migration patterns. If errors are complex, document them for checkpoint review.

After fixing type errors (if any), run build:
```bash
pnpm build
```

Build must succeed before proceeding to dev server test.
  </action>
  <verify>
Vue Router upgraded to 5.x.
`pnpm install` completes successfully.
`pnpm type-check` passes (with fixes applied if needed).
`pnpm build` succeeds.
If src/router/index.ts was modified, changes are minimal and focused on type compatibility.
  </verify>
  <done>
Vue Router 5 is installed and type-compatible.
Router configuration is updated for v5 (if needed).
Build succeeds with Vue Router 5.
  </done>
</task>

<task type="auto">
  <name>Task 4: Test development server and basic navigation</name>
  <files>package.json, pnpm-lock.yaml</files>
  <action>
Start development server:
```bash
pnpm dev
```

If dev server fails to start, capture the error and document it. Common issues:
- Router initialization errors
- Navigation guard errors
- Route matching errors

If dev server starts successfully, let it run (you can't interact, but confirm it starts).

Run a quick smoke test by checking if the server outputs "ready" or equivalent message.

If server starts, proceed to checkpoint for manual testing.
If server fails, debug the error:
- Check if error mentions router or navigation
- Look for deprecation warnings in console
- Document the error for user to help debug
  </action>
  <verify>
`pnpm dev` starts successfully.
Server shows "ready" or equivalent message.
No fatal errors in startup output.
  </verify>
  <done>
Development server starts with Vue Router 5.
Ready for manual navigation and feature testing.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete runtime dependency upgrade to major versions:
- Vue Router 4.5.1 → 5.0.1 (MAJOR version upgrade)
- @vueuse/core 13.3.0 → 14.1.0
- @deviltea/vue-router-middleware 0.0.3 → 0.0.4

This is the most critical checkpoint as Vue Router 5 is a major breaking release.
  </what-built>
  <how-to-verify>
Development server should be running from previous task. Visit http://localhost:5173

1. **Navigation testing:**
   - [ ] Home page loads without errors
   - [ ] Navigate to Playlists page - route transition works
   - [ ] Click into a specific playlist - dynamic route works
   - [ ] Use browser back button - navigation history works
   - [ ] Check URL updates correctly during navigation
   - [ ] Check for console errors related to routing

2. **Filter feature testing (uses VueUse composables):**
   - [ ] In a playlist, click filter toggle button
   - [ ] Dropdown opens/closes correctly (may use useClickOutside from VueUse)
   - [ ] Select marks and verify filtering works
   - [ ] Clear filters and verify all tracks show

3. **Music playback (router-dependent features):**
   - [ ] Play a track from a playlist
   - [ ] Music player controls work
   - [ ] Navigate to different playlist while music playing - player state persists

4. **Console checks:**
   - [ ] No Vue Router deprecation warnings
   - [ ] No VueUse-related errors
   - [ ] No middleware-related errors

5. **Build and preview:**
   ```bash
   pnpm build
   pnpm preview
   ```
   - [ ] Build succeeds without warnings about router
   - [ ] Preview mode works with all navigation features

If any test fails, document:
- What action caused the failure
- Exact error message (browser console and terminal)
- Whether it's a router-related issue or other
  </how-to-verify>
  <resume-signal>Type "approved" if all navigation and features work correctly, or describe failures in detail</resume-signal>
</task>

<task type="auto">
  <name>Task 5: Commit runtime dependency upgrades</name>
  <files>package.json, pnpm-lock.yaml, src/router/index.ts</files>
  <action>
Commit all runtime dependency upgrades:

```bash
git add package.json pnpm-lock.yaml src/router/index.ts
git commit -m "chore(deps): upgrade runtime dependencies to major versions

Core runtime:
- vue-router: 4.5.1 → 5.0.1 (BREAKING: Vue Router 5)
- @vueuse/core: 13.3.0 → 14.1.0
- @deviltea/vue-router-middleware: 0.0.3 → 0.0.4

Vue Router 5 migration:
[List any changes made to src/router/index.ts, or note "No code changes required"]

Verified through:
- Type checking and linting
- Build (dev and production)
- Manual navigation testing across all routes
- Filter feature testing (VueUse composables)
- Music playback with navigation

All features confirmed working with Vue Router 5."
```

If src/router/index.ts was NOT modified (backward compatible), adjust commit message to note that.
  </action>
  <verify>
Git commit is created.
`git log -1` shows detailed commit with Vue Router 5 migration notes.
`git diff HEAD~1` shows package.json, pnpm-lock.yaml, and src/router/index.ts (if modified).
  </verify>
  <done>
Runtime dependency upgrades committed to git.
Vue Router 5 migration documented in commit message.
  </done>
</task>

<task type="auto">
  <name>Task 6: Final verification and upgrade completion</name>
  <files>package.json</files>
  <action>
Run final verification to confirm all dependencies are up to date:

```bash
pnpm outdated
```

Check the output:
- If empty: All dependencies are at latest versions ✓
- If packages remain: These may be intentionally pinned or have specific constraints

Run full verification suite one last time:
```bash
pnpm type-check && pnpm lint && pnpm build
```

All commands must pass.

If `pnpm outdated` shows remaining packages, analyze them:
- Check if they're pnpm, @iconify-json, or other packages we intentionally skipped
- Document any packages that remain outdated and why

Generate summary statistics:
- Count of packages upgraded (patch, minor, major)
- Total time spent across all 4 plans
- Final state of dependencies
  </action>
  <verify>
`pnpm outdated` runs successfully (may show remaining packages or be empty).
Full verification suite passes.
Summary statistics are documented.
  </verify>
  <done>
All target dependencies are upgraded.
Any remaining outdated packages are documented.
Phase 4 upgrade is complete.
  </done>
</task>

</tasks>

<verification>
1. Run `pnpm outdated` - should be empty or only show intentionally skipped packages
2. Run full test suite: `pnpm type-check && pnpm lint && pnpm build && pnpm dev`
3. Manual test checklist: Navigation, filters, music playback, all major features
4. Git log shows 4 commits: patch, minor, dev-major, runtime-major
5. Project is stable and all features work correctly
</verification>

<success_criteria>
- [ ] Vue Router 5 successfully integrated and navigation works correctly
- [ ] @vueuse/core 14 works without breaking existing composable usage
- [ ] @deviltea/vue-router-middleware upgraded and middleware functions work
- [ ] All application features tested and verified working
- [ ] Full verification suite passes (type-check, lint, build, dev)
- [ ] Production build works and can be previewed
- [ ] Git history contains clean commit documenting runtime upgrades with migration notes
- [ ] `pnpm outdated` shows all target dependencies are current
</success_criteria>

<output>
After completion, create `.planning/phases/04-upgrade-dependencies/04-04-SUMMARY.md`
</output>
